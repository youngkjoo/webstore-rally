<!DOCTYPE html>
<html>
<head>
    <title>Grid Example</title>

    <script type="text/javascript" src="/apps/2.0p4/sdk.js"></script>
    <script type="text/javascript">
		Rally.onReady(function() {		
			Ext.define('CustomApp', {
				extend: 'Rally.app.App',
				componentCls: 'app',
				items: [
					{
						xtype: 'container',
						itemId: 'iterationSelector',
						style: {padding: '5px'}
					},
					{
						xtype: 'container',
						itemId: 'spacer1',
						style: {padding:'5px'}
					},
					{
						xtype: 'container',
						itemId: 'commands',
						style: {padding:'5px', width:'60%'}
					},
					{
						xtype: 'container',
						itemId: 'spacer2',
						style: {padding:'5px'}
					},
					{
						xtype: 'container',
						itemId: 'storyGrid',
						style: {padding:'5px', width:'90%'}
					},
				],			

				
				launch: function() {	
				/* Following can be used when we have shared iterations between teams.
				 * Until we are there, we will have to compare actual dates when filtering which is painful.
				 */
				/*
					this.iterationComboBox = this.down('#iterationSelector').add({
						xtype: 'rallyiterationcombobox',
						valueField: 'formattedName',
						listeners: {							
							ready: this._onIterationComboBoxReady,
							select: this._onIterationComboBoxSelect,
							scope: this
						}
					})
				*/
					
					this.datePicker = this.down('#iterationSelector').add({
						xtype: 'rallydatefield',
						fieldLabel: 'Sprint Start Date:',
						value: new Date(),
						listeners: {
							boxready: this._onDatePickerReady,
							select: this._onDatePickerSelect,
							scope: this
						}
					})
				},

/*				
				_onIterationComboBoxReady: function(combobox) {
					this._loadFeatures();
				},


				_onIterationComboBoxSelect: function() {
					this._loadFeatures();
				},
*/				
				
				_onDatePickerReady: function(picker) {
					this._loadFeatures();
				},
				

				_onDatePickerSelect: function(picker) {
					this._loadFeatures();
				},



				_loadFeatures: function() {
					var features = Ext.create('Rally.data.WsapiDataStore', {
						model: 'portfolioitem/feature',
						autoLoad: true,
						listeners: {
							load: function(store, data, success) {
								store.filterBy(this._filterStories,this);
								this._flattenStore(store);
							},
							scope: this
						},
						// Doing 'UserStories' followed by 'Iteration' retrieves Iteration field for each User Story
						fetch: ['FormattedID', 'Name', 'Project', 'UserStories', 'PlanEstimate', 'Iteration', 'StartDate', 'EndDate']
					});
				},


				/* Following can be used when we have shared iterations between teams.
				 * Until we are there, we will have to compare actual dates when filtering which is painful.
				 */
				/*
				_filterStories: function(record) {
					var selectedIteration = this.iterationComboBox.getValue();					
					var stories = record.get('UserStories');  // each record is a feature that has a collection of user stories

					for (var i=0, tot=stories.length; i < tot; i++) {
						if ((stories[i] != null) && (stories[i].Iteration != null)) {
							if (stories[i].Iteration.Name === selectedIteration) {
								return true;  // when match is found, return true and immediately stop the execution of _filterStories function
							}					
						}
					}
					return false;				
				},
				*/


				/* Following can be used when we have shared iterations between teams.
				 * Until we are there, we will have to compare actual dates when filtering which is painful.
				 */
				/*
				_flattenStore: function(store) {
console.log('_flattenStore, store:', store);
					var flattenedData = [];
					var selectedIteration = this.iterationComboBox.getValue();
					
					store.each(function(record) {
						var stories = record.get('UserStories');
						var featureID = record.get('FormattedID');
						var featureName = record.get('Name');
						var featureProject = record.get('Project').Name;


						for (var i=0, tot=stories.length; i < tot; i++) {
							if ((stories[i] != null) && (stories[i].Iteration != null)) {
								if (stories[i].Iteration.Name === selectedIteration) {
									flattenedData.push({
										FeatureID: featureID,
										FeatureName: featureName,
										FeatureProject: featureProject,
										StoryID: stories[i].FormattedID,
										StoryName: stories[i].Name,
										StoryEstimate: stories[i].PlanEstimate
									})				
								}					
							}
						}
					});
					
					var flattenedStore = Ext.create('Rally.data.custom.Store', {
						data: flattenedData,     
						fields: [
							{name: 'FeatureID', type: 'string'},
							{name: 'FeatureName', type: 'string'},
							{name: 'FeatureProject', type: 'string'},
							{name: 'StoryID', type: 'string'}, 
							{name: 'StoryName', type: 'string'},
							{name: 'StoryEstimate', type: 'float'}
						],
						groupField: 'FeatureName',
						listeners: {
							load: function(store, data, success) {
console.log('_flattenStore, flattenedStore:', store);
								this._updateStoryGrid(store);
							},
							scope: this
						}
					});
				},
				*/

				_filterStories: function(record) {
					var stories = record.get('UserStories');  // each record is a feature that has a collection of user stories

					for (var i=0, tot=stories.length; i < tot; i++) {
						if (this._compareIterationToSelectedDate(stories[i])) {
							return true;  // when match is found, return true and immediately stop the execution of _filterStories function
						}
					}
					return false;				
				},


				_flattenStore: function(store) {
					var flattenedData = [];
					
					store.each(function(record) {
						var stories = record.get('UserStories');
						var featureID = record.get('FormattedID');
						var featureName = record.get('Name');
						var featureProject = record.get('Project').Name;
						
						for (var i=0, tot=stories.length; i < tot; i++) {
							if (this._compareIterationToSelectedDate(stories[i])) {								
								flattenedData.push({
									FormattedID: featureID,
									FeatureName: featureName,
									FeatureProject: featureProject,
									StoryID: stories[i].FormattedID,
									StoryName: stories[i].Name,
									StoryEstimate: stories[i].PlanEstimate
								})				
							}
						}
					}, this);
					
					var flattenedStore = Ext.create('Rally.data.custom.Store', {
						data: flattenedData,
						pageSize: 10000,     
						fields: [
							{name: 'FormattedID', type: 'string'},
							{name: 'FeatureName', type: 'string'},
							{name: 'FeatureProject', type: 'string'},
							{name: 'StoryID', type: 'string'}, 
							{name: 'StoryName', type: 'string'},
							{name: 'StoryEstimate', type: 'float'}
						],
						groupField: 'FeatureName',
						listeners: {
							load: function(store, data, success) {
								this._updateStoryGrid(store);
							},
							scope: this
						}
					});
				},


				_compareIterationToSelectedDate: function(story) {
					var selectedMonth = new Date(this.datePicker.getValue()).getMonth();
					var selectedYear = new Date(this.datePicker.getValue()).getYear();

					if ((story != null) && (story.Iteration != null) && (story.Iteration.StartDate != null)) {
						var iterationMonth = new Date(story.Iteration.StartDate).getMonth();
						var iterationYear = new  Date(story.Iteration.StartDate).getYear();
						if ((iterationMonth === selectedMonth) && (iterationYear === selectedYear)) {
							return true;
						}	
					}
					return false;
				},



				_updateStoryGrid: function(store) {
					if (this._storyGrid === undefined) {
						this._createStoryGrid(store);
					}
					else {
						this._storyGrid.reconfigure(store);
					}				
				},
				
				_createStoryGrid: function(store) {
					var groupingFeature = Ext.create('Ext.grid.feature.GroupingSummary',{							
						enableGroupingMenu: true,
						startCollapsed: true
					});

					this._storyGrid = Ext.create('Ext.grid.Panel', {
						title: 'Commited Features',
						itemId: 'StoryGrid',
						store: store,
						columns: [
							{ text: 'FeatureID', dataIndex: 'FormattedID', menuDisabled: true, flex: 1, xtype: 'templatecolumn', tpl: Ext.create('Rally.ui.renderer.template.FormattedIDTemplate') },
							{ text: 'Feature', dataIndex: 'FeatureName', groupable: true, flex: 4 },
							{ text: 'Project', dataIndex: 'FeatureProject', groupable: true, flex: 1},
							{ text: 'StoryID', dataIndex: 'StoryID', menuDisabled: true, flex: 1 },
							{ text: 'StoryName', dataIndex: 'StoryName', groupable: false, flex: 8 },
							{ text: 'StoryEstimate', dataIndex: 'StoryEstimate', menuDisabled: true, flex: 1 }
						],
						features: [groupingFeature],
						//showPagingToolbar: true,
						//enableEditing: false
					})

					var collapseAllButton = Ext.create('Rally.ui.Button', {
						text: 'Collapse All',
						handler: function () {
							groupingFeature.collapseAll();
						}
					});
					
					var expandAllButton = Ext.create('Rally.ui.Button', {
						text: 'Expand All',
						handler: function () {
							groupingFeature.expandAll();
						}
					});

					this.down('#commands').add(collapseAllButton);
					this.down('#commands').add(expandAllButton);
					this.down('#storyGrid').add(this._storyGrid);
				},



			});

			Rally.launchApp('CustomApp', {
				name: 'Iteration Summary - Features and Stories'
			});		
		});

    </script>
</head>
<body></body>
</html>
